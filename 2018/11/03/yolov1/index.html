
<!DOCTYPE html>
<html lang="" class="loading">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eggTargaryen</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="eggTargaryen,"> 
    <meta name="description" content="个人简介：1994-2013:呆在山东潍坊​        在这里长大，读完小初高，还有大学预科班，哈哈。        
2013-2017: 呆在湖北武汉​        在wuli度过了马马虎,"> 
    <meta name="author" content="eggTargaryen"> 
    <link rel="alternative" href="atom.xml" title="eggTargaryen" type="application/atom+xml"> 
    <link rel="icon" href="/img/logo.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
</head>
</html>
<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">yolov1——原理+代码解读</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class="main">
        <h1 class="title">yolov1——原理+代码解读</h1>
        <div class="stuff">
            <span>十一月 03, 2018</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/yolo/">yolo</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="1-yolo原理"><a href="#1-yolo原理" class="headerlink" title="1.yolo原理"></a>1.yolo原理</h1><p><a href="https://arxiv.org/pdf/1506.02640.pdf" target="_blank" rel="noopener">论文地址</a></p>
<p><a href="http://noahsnail.com/2017/08/02/2017-8-2-YOLO论文翻译——中文版/" target="_blank" rel="noopener">中文翻译版</a></p>
<p><a href="https://blog.csdn.net/tangwei2014/article/details/50915317" target="_blank" rel="noopener">快速掌握要点版本</a></p>
<h1 id="2-yolo-tensorflow代码解读"><a href="#2-yolo-tensorflow代码解读" class="headerlink" title="2.yolo tensorflow代码解读"></a>2.yolo tensorflow代码解读</h1><p><a href="https://github.com/hizhangp/yolo_tensorflow" target="_blank" rel="noopener">原代码地址</a></p>
<p>yolo_net.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> yolo.config <span class="keyword">as</span> cfg</span><br><span class="line"></span><br><span class="line">slim = tf.contrib.slim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义YoloNet网络</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YOLONet</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, is_training=True)</span>:</span>    <span class="comment">#类的初始化</span></span><br><span class="line">        self.classes = cfg.CLASSES    <span class="comment">#PASCAL VOC数据集的20个数据类</span></span><br><span class="line">        self.num_class = len(self.classes)  <span class="comment">#20个类别</span></span><br><span class="line">        self.image_size = cfg.IMAGE_SIZE   <span class="comment">#图片的大小</span></span><br><span class="line">        self.cell_size = cfg.CELL_SIZE    <span class="comment">#整张输入图片划分为cell_size * cell_size的网格</span></span><br><span class="line">        self.boxes_per_cell = cfg.BOXES_PER_CELL  <span class="comment">#每个cell负责预测多少个(mayebe 2)bounding box</span></span><br><span class="line">        self.output_size = (self.cell_size * self.cell_size) *\</span><br><span class="line">            (self.num_class + self.boxes_per_cell * <span class="number">5</span>)    <span class="comment">#最后输出的tensor大小，其为S*S*(C+5*B),具体可以看论文</span></span><br><span class="line">        self.scale = <span class="number">1.0</span> * self.image_size / self.cell_size  <span class="comment">#每个cell像素的大小</span></span><br><span class="line">        self.boundary1 = self.cell_size * self.cell_size * self.num_class  <span class="comment">#类似于7*7*20</span></span><br><span class="line">        self.boundary2 = self.boundary1 +\</span><br><span class="line">            self.cell_size * self.cell_size * self.boxes_per_cell  <span class="comment">#类似于 7*7*20 + 7*7*2</span></span><br><span class="line"></span><br><span class="line">        self.object_scale = cfg.OBJECT_SCALE   <span class="comment">#这些是论文中涉及的参数，具体可看论文(You Only Look Once: Unified, Real-Time Object Detection)</span></span><br><span class="line">        self.noobject_scale = cfg.NOOBJECT_SCALE</span><br><span class="line">        self.class_scale = cfg.CLASS_SCALE</span><br><span class="line">        self.coord_scale = cfg.COORD_SCALE</span><br><span class="line"></span><br><span class="line">        self.learning_rate = cfg.LEARNING_RATE  <span class="comment">#学习率</span></span><br><span class="line">        self.batch_size = cfg.BATCH_SIZE  <span class="comment">#batch_size</span></span><br><span class="line">        self.alpha = cfg.ALPHA  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">        self.offset = np.transpose(np.reshape(np.array(   <span class="comment">#reshape之后再转置，变成7*7*2的三维数组</span></span><br><span class="line">            [np.arange(self.cell_size)] * self.cell_size * self.boxes_per_cell),</span><br><span class="line">            (self.boxes_per_cell, self.cell_size, self.cell_size)), (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.images = tf.placeholder(</span><br><span class="line">            tf.float32, [<span class="keyword">None</span>, self.image_size, self.image_size, <span class="number">3</span>],</span><br><span class="line">            name=<span class="string">'images'</span>)   <span class="comment">#定义输入的placeholder，需要喂饱的数据, batch_size * 448 * 448 *3 ,</span></span><br><span class="line">        self.logits = self.build_network(</span><br><span class="line">            self.images, num_outputs=self.output_size, alpha=self.alpha,</span><br><span class="line">            is_training=is_training)  <span class="comment"># 构建网络，预测值，在本程序中，其格式为 [batch_size , 7 * 7 * （20 + 2 * 5）]，其中的20表示PASCAL VOC数据集的20个类别</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_training:   <span class="comment">#training为true时</span></span><br><span class="line">            self.labels = tf.placeholder(</span><br><span class="line">                tf.float32,</span><br><span class="line">                [<span class="keyword">None</span>, self.cell_size, self.cell_size, <span class="number">5</span> + self.num_class])   <span class="comment"># 需要喂饱的数据，在本程序中其格式为：[batch_size,7 ,7 ,25]</span></span><br><span class="line">            self.loss_layer(self.logits, self.labels)   <span class="comment">#预测值和真实值的比较，得到loss</span></span><br><span class="line">            self.total_loss = tf.losses.get_total_loss()   <span class="comment">#将所有的loss求和</span></span><br><span class="line">            tf.summary.scalar(<span class="string">'total_loss'</span>, self.total_loss)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_network</span><span class="params">(self,     #用slim构建网络，简单高效</span></span></span><br><span class="line"><span class="function"><span class="params">                      images,</span></span></span><br><span class="line"><span class="function"><span class="params">                      num_outputs,</span></span></span><br><span class="line"><span class="function"><span class="params">                      alpha,</span></span></span><br><span class="line"><span class="function"><span class="params">                      keep_prob=<span class="number">0.5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      is_training=True,</span></span></span><br><span class="line"><span class="function"><span class="params">                      scope=<span class="string">'yolo'</span>)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            <span class="keyword">with</span> slim.arg_scope(</span><br><span class="line">                [slim.conv2d, slim.fully_connected],  <span class="comment">#卷积层加上全连接层</span></span><br><span class="line">                activation_fn=leaky_relu(alpha),   <span class="comment">#用的是leaky_relu激活函数</span></span><br><span class="line">                weights_regularizer=slim.l2_regularizer(<span class="number">0.0005</span>), <span class="comment">#L2正则化，防止过拟合</span></span><br><span class="line">                weights_initializer=tf.truncated_normal_initializer(<span class="number">0.0</span>, <span class="number">0.01</span>)  <span class="comment">#权重初始化</span></span><br><span class="line">            ):</span><br><span class="line"></span><br><span class="line">                <span class="comment">#这里先执行填充操作</span></span><br><span class="line">                <span class="comment"># t = [[2, 3, 4], [5, 6, 7]], paddings = [[1, 1], [2, 2]]，mode = "CONSTANT"</span></span><br><span class="line">                <span class="comment">#</span></span><br><span class="line">                <span class="comment"># 那么sess.run(tf.pad(t, paddings, "CONSTANT"))</span></span><br><span class="line">                <span class="comment"># 的输出结果为：</span></span><br><span class="line">                <span class="comment">#</span></span><br><span class="line">                <span class="comment"># array([[0, 0, 0, 0, 0, 0, 0],</span></span><br><span class="line">                <span class="comment">#        [0, 0, 2, 3, 4, 0, 0],</span></span><br><span class="line">                <span class="comment">#        [0, 0, 5, 6, 7, 0, 0],</span></span><br><span class="line">                <span class="comment">#        [0, 0, 0, 0, 0, 0, 0]], dtype=int32)</span></span><br><span class="line">                <span class="comment">#</span></span><br><span class="line">                <span class="comment"># 可以看到，上，下，左，右分别填充了1, 1, 2, 2</span></span><br><span class="line">                <span class="comment"># 行刚好和paddings = [[1, 1], [2, 2]]</span></span><br><span class="line">                <span class="comment"># 相等，零填充</span></span><br><span class="line">                <span class="comment">#因为这里有4维，batch和channel维没有填充，只填充了image_height,image_width这两个维度，0填充</span></span><br><span class="line">                net = tf.pad(</span><br><span class="line">                    images, np.array([[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">3</span>, <span class="number">3</span>], [<span class="number">3</span>, <span class="number">3</span>], [<span class="number">0</span>, <span class="number">0</span>]]),</span><br><span class="line">                    name=<span class="string">'pad_1'</span>)</span><br><span class="line">                net = slim.conv2d(</span><br><span class="line">                    net, <span class="number">64</span>, <span class="number">7</span>, <span class="number">2</span>, padding=<span class="string">'VALID'</span>, scope=<span class="string">'conv_2'</span>)  <span class="comment">#这里的64是指卷积核个数，7是指卷积核的高度和宽度，2是指步长，valid表示没有填充</span></span><br><span class="line">                net = slim.max_pool2d(net, <span class="number">2</span>, padding=<span class="string">'SAME'</span>, scope=<span class="string">'pool_3'</span>)  <span class="comment">#max_pool, 大小2*2, stride:2</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">192</span>, <span class="number">3</span>, scope=<span class="string">'conv_4'</span>)   <span class="comment">#这里的192是指卷积核的个数，3是指卷积核的高度和宽度，默认的步长为1</span></span><br><span class="line">                net = slim.max_pool2d(net, <span class="number">2</span>, padding=<span class="string">'SAME'</span>, scope=<span class="string">'pool_5'</span>)  <span class="comment">#max_pool,大小为2*2，strides:2</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">128</span>, <span class="number">1</span>, scope=<span class="string">'conv_6'</span>) <span class="comment">#128个卷积核，大小为1*1，默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">256</span>, <span class="number">3</span>, scope=<span class="string">'conv_7'</span>) <span class="comment">#256个卷积核，大小为3*3，默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">256</span>, <span class="number">1</span>, scope=<span class="string">'conv_8'</span>) <span class="comment">#256个卷积核，大小为1*1，默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">3</span>, scope=<span class="string">'conv_9'</span>) <span class="comment">#512个卷积核，大小为3*3，默认步长为3</span></span><br><span class="line">                net = slim.max_pool2d(net, <span class="number">2</span>, padding=<span class="string">'SAME'</span>, scope=<span class="string">'pool_10'</span>) <span class="comment">#max_pool, 大小为2*2，stride:2</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">256</span>, <span class="number">1</span>, scope=<span class="string">'conv_11'</span>)  <span class="comment">#256个卷积核，大小为1*1, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">3</span>, scope=<span class="string">'conv_12'</span>)  <span class="comment">#512个卷积核，大小为3*3,默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">256</span>, <span class="number">1</span>, scope=<span class="string">'conv_13'</span>)  <span class="comment">#256个卷积核，大小为1*1, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">3</span>, scope=<span class="string">'conv_14'</span>)   <span class="comment">#512个卷积核，大小为3*3, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">256</span>, <span class="number">1</span>, scope=<span class="string">'conv_15'</span>)  <span class="comment">#256个卷积核，大小为1*1, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">3</span>, scope=<span class="string">'conv_16'</span>)  <span class="comment">#512个卷积核，大小为3*3, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">256</span>, <span class="number">1</span>, scope=<span class="string">'conv_17'</span>)  <span class="comment">#256个卷积核，大小为1*1, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">3</span>, scope=<span class="string">'conv_18'</span>)   <span class="comment">#512个卷积核，大小为3*3, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">1</span>, scope=<span class="string">'conv_19'</span>)  <span class="comment">#256个卷积核，大小为1*1, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">1024</span>, <span class="number">3</span>, scope=<span class="string">'conv_20'</span>)  <span class="comment">#1024个卷积核，大小为3*3，默认步长为1</span></span><br><span class="line">                net = slim.max_pool2d(net, <span class="number">2</span>, padding=<span class="string">'SAME'</span>, scope=<span class="string">'pool_21'</span>) <span class="comment"># max_pool, 大小为2*2，strides: 2</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">1</span>, scope=<span class="string">'conv_22'</span>)  <span class="comment">#512卷积核，大小为1*1，默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">1024</span>, <span class="number">3</span>, scope=<span class="string">'conv_23'</span>) <span class="comment">#1024卷积核，大小为3*3，默认步长1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">512</span>, <span class="number">1</span>, scope=<span class="string">'conv_24'</span>)  <span class="comment">#512卷积核，大小为1*1，默认步长1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">1024</span>, <span class="number">3</span>, scope=<span class="string">'conv_25'</span>)  <span class="comment">#1024卷积核，大小为3*3, 默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">1024</span>, <span class="number">3</span>, scope=<span class="string">'conv_26'</span>)  <span class="comment">#1024卷积核，大小为3*3，默认步长为1</span></span><br><span class="line">                net = tf.pad(</span><br><span class="line">                    net, np.array([[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">0</span>]]),</span><br><span class="line">                    name=<span class="string">'pad_27'</span>)     <span class="comment">#padding, 第一个维度batch和第四个维度channels不用管，只padding卷积核的高度和宽度</span></span><br><span class="line">                net = slim.conv2d(</span><br><span class="line">                    net, <span class="number">1024</span>, <span class="number">3</span>, <span class="number">2</span>, padding=<span class="string">'VALID'</span>, scope=<span class="string">'conv_28'</span>)  <span class="comment">#1024卷积核，大小3*3，步长为2</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">1024</span>, <span class="number">3</span>, scope=<span class="string">'conv_29'</span>)   <span class="comment">#1024卷积核，大小为3*3，默认步长为1</span></span><br><span class="line">                net = slim.conv2d(net, <span class="number">1024</span>, <span class="number">3</span>, scope=<span class="string">'conv_30'</span>)   <span class="comment">#1024卷积核，大小为3*3，默认步长为1</span></span><br><span class="line">                net = tf.transpose(net, [<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>], name=<span class="string">'trans_31'</span>) <span class="comment">#转置，由[batch, image_height,image_width,channels]变成[bacth, channels, image_height,image_width]</span></span><br><span class="line">                net = slim.flatten(net, scope=<span class="string">'flat_32'</span>)  <span class="comment">#将输入扁平化，但保留batch_size, 假设第一位是batch，实际上第一维也是batch</span></span><br><span class="line">                net = slim.fully_connected(net, <span class="number">512</span>, scope=<span class="string">'fc_33'</span>)   <span class="comment">#全连接层,神经元个数</span></span><br><span class="line">                net = slim.fully_connected(net, <span class="number">4096</span>, scope=<span class="string">'fc_34'</span>)  <span class="comment">#全连接层，神经元个数</span></span><br><span class="line">                net = slim.dropout(  <span class="comment">#dropout，防止过拟合</span></span><br><span class="line">                    net, keep_prob=keep_prob, is_training=is_training,</span><br><span class="line">                    scope=<span class="string">'dropout_35'</span>)</span><br><span class="line">                net = slim.fully_connected(    <span class="comment">#全连接层</span></span><br><span class="line">                    net, num_outputs, activation_fn=<span class="keyword">None</span>, scope=<span class="string">'fc_36'</span>)</span><br><span class="line">        <span class="keyword">return</span> net</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calc_iou</span><span class="params">(self, boxes1, boxes2, scope=<span class="string">'iou'</span>)</span>:</span>   <span class="comment">#计算IOU的函数</span></span><br><span class="line">        <span class="string">"""calculate ious</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">          boxes1: 5-D tensor [BATCH_SIZE, CELL_SIZE, CELL_SIZE, BOXES_PER_CELL, 4]  ====&gt; (x_center, y_center, w, h)</span></span><br><span class="line"><span class="string">          boxes2: 5-D tensor [BATCH_SIZE, CELL_SIZE, CELL_SIZE, BOXES_PER_CELL, 4] ===&gt; (x_center, y_center, w, h)</span></span><br><span class="line"><span class="string">        Return:</span></span><br><span class="line"><span class="string">          iou: 4-D tensor [BATCH_SIZE, CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            <span class="comment"># transform (x_center, y_center, w, h) to (x1, y1, x2, y2)</span></span><br><span class="line">            boxes1_t = tf.stack([boxes1[..., <span class="number">0</span>] - boxes1[..., <span class="number">2</span>] / <span class="number">2.0</span>,</span><br><span class="line">                                 boxes1[..., <span class="number">1</span>] - boxes1[..., <span class="number">3</span>] / <span class="number">2.0</span>,</span><br><span class="line">                                 boxes1[..., <span class="number">0</span>] + boxes1[..., <span class="number">2</span>] / <span class="number">2.0</span>,</span><br><span class="line">                                 boxes1[..., <span class="number">1</span>] + boxes1[..., <span class="number">3</span>] / <span class="number">2.0</span>],</span><br><span class="line">                                axis=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">            boxes2_t = tf.stack([boxes2[..., <span class="number">0</span>] - boxes2[..., <span class="number">2</span>] / <span class="number">2.0</span>,</span><br><span class="line">                                 boxes2[..., <span class="number">1</span>] - boxes2[..., <span class="number">3</span>] / <span class="number">2.0</span>,</span><br><span class="line">                                 boxes2[..., <span class="number">0</span>] + boxes2[..., <span class="number">2</span>] / <span class="number">2.0</span>,</span><br><span class="line">                                 boxes2[..., <span class="number">1</span>] + boxes2[..., <span class="number">3</span>] / <span class="number">2.0</span>],</span><br><span class="line">                                axis=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate the left up point &amp; right down point</span></span><br><span class="line">            lu = tf.maximum(boxes1_t[..., :<span class="number">2</span>], boxes2_t[..., :<span class="number">2</span>])</span><br><span class="line">            rd = tf.minimum(boxes1_t[..., <span class="number">2</span>:], boxes2_t[..., <span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># intersection</span></span><br><span class="line">            intersection = tf.maximum(<span class="number">0.0</span>, rd - lu)</span><br><span class="line">            inter_square = intersection[..., <span class="number">0</span>] * intersection[..., <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate the boxs1 square and boxs2 square</span></span><br><span class="line">            square1 = boxes1[..., <span class="number">2</span>] * boxes1[..., <span class="number">3</span>]</span><br><span class="line">            square2 = boxes2[..., <span class="number">2</span>] * boxes2[..., <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">            union_square = tf.maximum(square1 + square2 - inter_square, <span class="number">1e-10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tf.clip_by_value(inter_square / union_square, <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#这个是定义损失函数的，具体可以看论文</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loss_layer</span><span class="params">(self, predicts, labels, scope=<span class="string">'loss_layer'</span>)</span>:</span>   <span class="comment">#定义损失函数，损失函数的具体形似可以查看论文, label的格式为[batch_size, 7, 7, 25]</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            predict_classes = tf.reshape(  <span class="comment">#reshape一下，每个cell一个框，变成[batch_size, 7, 7, 20]</span></span><br><span class="line">                predicts[:, :self.boundary1],</span><br><span class="line">                [self.batch_size, self.cell_size, self.cell_size, self.num_class])</span><br><span class="line">            predict_scales = tf.reshape( <span class="comment">#reshape一下，7*7*20 ~ 7*7*22, 就是分别找到每个cell的两个框的置信度,这里是两个框，可自定义,变成[batch_size, 7, 7, 2]</span></span><br><span class="line">                predicts[:, self.boundary1:self.boundary2],</span><br><span class="line">                [self.batch_size, self.cell_size, self.cell_size, self.boxes_per_cell])</span><br><span class="line">            predict_boxes = tf.reshape( <span class="comment">#reshape，就是分别找到每个cell中两个框的坐标（x_center, y_center, w, h），这里是两个框，可自定义, 变成[batch_size, 7, 7, 2, 4]</span></span><br><span class="line">                predicts[:, self.boundary2:],  <span class="comment">#7 * 7 * 22 ~ 7 * 7 * 30，</span></span><br><span class="line">                [self.batch_size, self.cell_size, self.cell_size, self.boxes_per_cell, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment">#下面是对label部分进行reshape</span></span><br><span class="line">            response = tf.reshape(</span><br><span class="line">                labels[..., <span class="number">0</span>],</span><br><span class="line">                [self.batch_size, self.cell_size, self.cell_size, <span class="number">1</span>])    <span class="comment">#reshape, 就是查看哪个cell负责标记object,是的话就为1 ，否则是0 ，维度形式：[batch_size, 7, 7, 1]</span></span><br><span class="line">            boxes = tf.reshape(</span><br><span class="line">                labels[..., <span class="number">1</span>:<span class="number">5</span>],</span><br><span class="line">                [self.batch_size, self.cell_size, self.cell_size, <span class="number">1</span>, <span class="number">4</span>])  <span class="comment">#找到这个cell负责的框的位置，其形式为：(x_center,y_center,width,height), 其维度为：[batch_size, 7, 7, 1, 4]</span></span><br><span class="line">            boxes = tf.tile(</span><br><span class="line">                boxes, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, self.boxes_per_cell, <span class="number">1</span>]) / self.image_size   <span class="comment"># tile() 平铺之意，用于在同一维度上的复制, 变成[batch_size, 7, 7, 2, 4]， 除以image_size就是得到相对于整张图片的比例</span></span><br><span class="line">            classes = labels[..., <span class="number">5</span>:]          <span class="comment">#找到这个cell负责的框所框出的类别，有20个类别, 变成[batch_size, 7, 7, 20]，正确的类别对应的位置为1，其它为0</span></span><br><span class="line"></span><br><span class="line">            offset = tf.reshape(</span><br><span class="line">                tf.constant(self.offset, dtype=tf.float32),</span><br><span class="line">                [<span class="number">1</span>, self.cell_size, self.cell_size, self.boxes_per_cell])    <span class="comment">#由7*7*2 reshape成 1*7*7*2</span></span><br><span class="line">            offset = tf.tile(offset, [self.batch_size, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>])  <span class="comment">#在第一个维度上进行复制，变成 [batch_size, 7, 7,2]</span></span><br><span class="line">            offset_tran = tf.transpose(offset, (<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>))  <span class="comment">#维度为[batch_size, 7, 7, 2]</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#offset_tran如下，只不过batch_size=1</span></span><br><span class="line">            <span class="comment"># [[[[0. 0.]</span></span><br><span class="line">            <span class="comment"># [0. 0.]</span></span><br><span class="line">            <span class="comment"># [0. 0.]</span></span><br><span class="line">            <span class="comment"># [0. 0.]</span></span><br><span class="line">            <span class="comment"># [0. 0.]</span></span><br><span class="line">            <span class="comment"># [0. 0.]</span></span><br><span class="line">            <span class="comment"># [0. 0.]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># [[1. 1.]</span></span><br><span class="line">            <span class="comment">#  [1. 1.]</span></span><br><span class="line">            <span class="comment"># [1. 1.]</span></span><br><span class="line">            <span class="comment"># [1. 1.]</span></span><br><span class="line">            <span class="comment"># [1. 1.]</span></span><br><span class="line">            <span class="comment"># [1. 1.]</span></span><br><span class="line">            <span class="comment"># [1. 1.]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># [[2. 2.]</span></span><br><span class="line">            <span class="comment">#  [2. 2.]</span></span><br><span class="line">            <span class="comment"># [2. 2.]</span></span><br><span class="line">            <span class="comment"># [2. 2.]</span></span><br><span class="line">            <span class="comment"># [2. 2.]</span></span><br><span class="line">            <span class="comment"># [2. 2.]</span></span><br><span class="line">            <span class="comment"># [2. 2.]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># [[3. 3.]</span></span><br><span class="line">            <span class="comment">#  [3. 3.]</span></span><br><span class="line">            <span class="comment"># [3. 3.]</span></span><br><span class="line">            <span class="comment"># [3. 3.]</span></span><br><span class="line">            <span class="comment"># [3. 3.]</span></span><br><span class="line">            <span class="comment"># [3. 3.]</span></span><br><span class="line">            <span class="comment"># [3. 3.]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># [[4. 4.]</span></span><br><span class="line">            <span class="comment">#  [4. 4.]</span></span><br><span class="line">            <span class="comment"># [4. 4.]</span></span><br><span class="line">            <span class="comment"># [4. 4.]</span></span><br><span class="line">            <span class="comment"># [4. 4.]</span></span><br><span class="line">            <span class="comment"># [4. 4.]</span></span><br><span class="line">            <span class="comment"># [4. 4.]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># [[5. 5.]</span></span><br><span class="line">            <span class="comment">#  [5. 5.]</span></span><br><span class="line">            <span class="comment"># [5. 5.]</span></span><br><span class="line">            <span class="comment"># [5. 5.]</span></span><br><span class="line">            <span class="comment"># [5. 5.]</span></span><br><span class="line">            <span class="comment"># [5. 5.]</span></span><br><span class="line">            <span class="comment"># [5. 5.]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># [[6. 6.]</span></span><br><span class="line">            <span class="comment">#  [6. 6.]</span></span><br><span class="line">            <span class="comment"># [6. 6.]</span></span><br><span class="line">            <span class="comment"># [6. 6.]</span></span><br><span class="line">            <span class="comment"># [6. 6.]</span></span><br><span class="line">            <span class="comment"># [6. 6.]</span></span><br><span class="line">            <span class="comment"># [6. 6.]]]]</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">            predict_boxes_tran = tf.stack(   <span class="comment">#相对于整张特征图来说，找到相对于特征图大小的中心点，和宽度以及高度的开方， 其格式为[batch_size, 7, 7, 2, 4]</span></span><br><span class="line">                [(predict_boxes[..., <span class="number">0</span>] + offset) / self.cell_size,   <span class="comment">#self.cell=7</span></span><br><span class="line">                 (predict_boxes[..., <span class="number">1</span>] + offset_tran) / self.cell_size,</span><br><span class="line">                 tf.square(predict_boxes[..., <span class="number">2</span>]),    <span class="comment">#宽度的平方，和论文中的开方对应，具体请看论文</span></span><br><span class="line">                 tf.square(predict_boxes[..., <span class="number">3</span>])], axis=<span class="number">-1</span>)  <span class="comment">#高度的平方，</span></span><br><span class="line"></span><br><span class="line">            iou_predict_truth = self.calc_iou(predict_boxes_tran, boxes)   <span class="comment">#计算IOU,  其格式为： [batch_size, 7, 7, 2]</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate I tensor [BATCH_SIZE, CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line">            object_mask = tf.reduce_max(iou_predict_truth, <span class="number">3</span>, keep_dims=<span class="keyword">True</span>)  <span class="comment"># Computes the maximum of elements across dimensions of a tensor, 在第四个维度上，维度从0开始算</span></span><br><span class="line">            object_mask = tf.cast(</span><br><span class="line">                (iou_predict_truth &gt;= object_mask), tf.float32) * response   <span class="comment">#其维度为[batch_size, 7, 7, 2]  , 如果cell中真实有目标，那么该cell内iou最大的那个框的相应位置为1（就是负责预测该框），其余为0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate no_I tensor [CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line">            noobject_mask = tf.ones_like(</span><br><span class="line">                object_mask, dtype=tf.float32) - object_mask    <span class="comment">#其维度为[batch_size, 7 , 7, 2]， 真实没有目标的区域都为1，真实有目标的区域为0</span></span><br><span class="line"></span><br><span class="line">            boxes_tran = tf.stack(     <span class="comment">#stack这是一个矩阵拼接的操作， 得到x_center, y_center相对于该cell左上角的偏移值， 宽度和高度是相对于整张图片的比例</span></span><br><span class="line">                [boxes[..., <span class="number">0</span>] * self.cell_size - offset,</span><br><span class="line">                 boxes[..., <span class="number">1</span>] * self.cell_size - offset_tran,</span><br><span class="line">                 tf.sqrt(boxes[..., <span class="number">2</span>]),   <span class="comment">#宽度开方，和论文对应</span></span><br><span class="line">                 tf.sqrt(boxes[..., <span class="number">3</span>])], axis=<span class="number">-1</span>)  <span class="comment">#高度开方，和论文对应</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># class_loss, 计算类别的损失</span></span><br><span class="line">            class_delta = response * (predict_classes - classes)</span><br><span class="line">            class_loss = tf.reduce_mean(   <span class="comment">#平方差损失函数</span></span><br><span class="line">                tf.reduce_sum(tf.square(class_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'class_loss'</span>) * self.class_scale   <span class="comment"># self.class_scale为损失函数前面的系数</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 有目标的时候，置信度损失函数</span></span><br><span class="line">            object_delta = object_mask * (predict_scales - iou_predict_truth)  <span class="comment">#用iou_predict_truth替代真实的置信度，真的妙，佩服的5体投递</span></span><br><span class="line">            object_loss = tf.reduce_mean(  <span class="comment">#平方差损失函数</span></span><br><span class="line">                tf.reduce_sum(tf.square(object_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'object_loss'</span>) * self.object_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 没有目标的时候，置信度的损失函数</span></span><br><span class="line">            noobject_delta = noobject_mask * predict_scales</span><br><span class="line">            noobject_loss = tf.reduce_mean(       <span class="comment">#平方差损失函数</span></span><br><span class="line">                tf.reduce_sum(tf.square(noobject_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'noobject_loss'</span>) * self.noobject_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 框坐标的损失，只计算有目标的cell中iou最大的那个框的损失，即用这个iou最大的框来负责预测这个框，其它不管，乘以0</span></span><br><span class="line">            coord_mask = tf.expand_dims(object_mask, <span class="number">4</span>)  <span class="comment"># object_mask其维度为：[batch_size, 7, 7, 2]， 扩展维度之后变成[batch_size, 7, 7, 2, 1]</span></span><br><span class="line">            boxes_delta = coord_mask * (predict_boxes - boxes_tran)     <span class="comment">#predict_boxes维度为： [batch_size, 7, 7, 2, 4]，这些框的坐标都是偏移值</span></span><br><span class="line">            coord_loss = tf.reduce_mean(  <span class="comment">#平方差损失函数</span></span><br><span class="line">                tf.reduce_sum(tf.square(boxes_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]),</span><br><span class="line">                name=<span class="string">'coord_loss'</span>) * self.coord_scale</span><br><span class="line"></span><br><span class="line">            tf.losses.add_loss(class_loss)</span><br><span class="line">            tf.losses.add_loss(object_loss)</span><br><span class="line">            tf.losses.add_loss(noobject_loss)</span><br><span class="line">            tf.losses.add_loss(coord_loss)  <span class="comment">#将各个损失总结起来</span></span><br><span class="line"></span><br><span class="line">            tf.summary.scalar(<span class="string">'class_loss'</span>, class_loss)</span><br><span class="line">            tf.summary.scalar(<span class="string">'object_loss'</span>, object_loss)</span><br><span class="line">            tf.summary.scalar(<span class="string">'noobject_loss'</span>, noobject_loss)</span><br><span class="line">            tf.summary.scalar(<span class="string">'coord_loss'</span>, coord_loss)</span><br><span class="line"></span><br><span class="line">            tf.summary.histogram(<span class="string">'boxes_delta_x'</span>, boxes_delta[..., <span class="number">0</span>])</span><br><span class="line">            tf.summary.histogram(<span class="string">'boxes_delta_y'</span>, boxes_delta[..., <span class="number">1</span>])</span><br><span class="line">            tf.summary.histogram(<span class="string">'boxes_delta_w'</span>, boxes_delta[..., <span class="number">2</span>])</span><br><span class="line">            tf.summary.histogram(<span class="string">'boxes_delta_h'</span>, boxes_delta[..., <span class="number">3</span>])</span><br><span class="line">            tf.summary.histogram(<span class="string">'iou'</span>, iou_predict_truth)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaky_relu</span><span class="params">(alpha)</span>:</span>  <span class="comment">#leaky_relu激活函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">op</span><span class="params">(inputs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> tf.nn.leaky_relu(inputs, alpha=alpha, name=<span class="string">'leaky_relu'</span>)</span><br><span class="line">    <span class="keyword">return</span> op</span><br></pre></td></tr></table></figure>
<p>config.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># path and dataset parameter</span></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">DATA_PATH = <span class="string">'data'</span></span><br><span class="line"></span><br><span class="line">PASCAL_PATH = os.path.join(DATA_PATH, <span class="string">'pascal_voc'</span>)</span><br><span class="line"></span><br><span class="line">CACHE_PATH = os.path.join(PASCAL_PATH, <span class="string">'cache'</span>)</span><br><span class="line"></span><br><span class="line">OUTPUT_DIR = os.path.join(PASCAL_PATH, <span class="string">'output'</span>)   <span class="comment">#存放输出文件的地方，data/pascal_voc/output</span></span><br><span class="line"></span><br><span class="line">WEIGHTS_DIR = os.path.join(PASCAL_PATH, <span class="string">'weights'</span>)  <span class="comment">#weights_dir, 路径为data/pascal_voc/weights</span></span><br><span class="line"></span><br><span class="line">WEIGHTS_FILE = <span class="keyword">None</span>   <span class="comment">#weights file</span></span><br><span class="line"><span class="comment"># WEIGHTS_FILE = os.path.join(DATA_PATH, 'weights', 'YOLO_small.ckpt')</span></span><br><span class="line"></span><br><span class="line">CLASSES = [<span class="string">'aeroplane'</span>, <span class="string">'bicycle'</span>, <span class="string">'bird'</span>, <span class="string">'boat'</span>, <span class="string">'bottle'</span>, <span class="string">'bus'</span>,</span><br><span class="line">           <span class="string">'car'</span>, <span class="string">'cat'</span>, <span class="string">'chair'</span>, <span class="string">'cow'</span>, <span class="string">'diningtable'</span>, <span class="string">'dog'</span>, <span class="string">'horse'</span>,</span><br><span class="line">           <span class="string">'motorbike'</span>, <span class="string">'person'</span>, <span class="string">'pottedplant'</span>, <span class="string">'sheep'</span>, <span class="string">'sofa'</span>,</span><br><span class="line">           <span class="string">'train'</span>, <span class="string">'tvmonitor'</span>]    <span class="comment">#PASCAL VOC数据集的20个类别</span></span><br><span class="line"></span><br><span class="line">FLIPPED = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># model parameter</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">IMAGE_SIZE = <span class="number">448</span>     <span class="comment">#输入图片的大小</span></span><br><span class="line"></span><br><span class="line">CELL_SIZE = <span class="number">7</span>     <span class="comment">#整张图片分为cell_size * cell_size的大小</span></span><br><span class="line"></span><br><span class="line">BOXES_PER_CELL = <span class="number">2</span>    <span class="comment">#每个cell负责预测两个bounding box</span></span><br><span class="line"></span><br><span class="line">ALPHA = <span class="number">0.1</span>     <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">DISP_CONSOLE = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下面这几个是论文中涉及的参数</span></span><br><span class="line">OBJECT_SCALE = <span class="number">1.0</span></span><br><span class="line">NOOBJECT_SCALE = <span class="number">1.0</span></span><br><span class="line">CLASS_SCALE = <span class="number">2.0</span></span><br><span class="line">COORD_SCALE = <span class="number">5.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># solver parameter</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">GPU = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">LEARNING_RATE = <span class="number">0.0001</span>   <span class="comment">#学习率</span></span><br><span class="line"></span><br><span class="line">DECAY_STEPS = <span class="number">30000</span></span><br><span class="line"></span><br><span class="line">DECAY_RATE = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">STAIRCASE = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">BATCH_SIZE = <span class="number">45</span>   <span class="comment">#batch size</span></span><br><span class="line"></span><br><span class="line">MAX_ITER = <span class="number">1</span>     <span class="comment">#迭代次数，可自定义</span></span><br><span class="line"></span><br><span class="line">SUMMARY_ITER = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">SAVE_ITER = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># test parameter</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">THRESHOLD = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">IOU_THRESHOLD = <span class="number">0.5</span>   <span class="comment">#IOU阈值0.5</span></span><br></pre></td></tr></table></figure>
<p>pascal_voc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> yolo.config <span class="keyword">as</span> cfg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pascal_voc</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, phase, rebuild=False)</span>:</span></span><br><span class="line">        self.devkil_path = os.path.join(cfg.PASCAL_PATH, <span class="string">'VOCdevkit'</span>)   <span class="comment">#data/pascal_voc/VOCdevkit</span></span><br><span class="line">        self.data_path = os.path.join(self.devkil_path, <span class="string">'VOC2007'</span>)      <span class="comment">#data/pascal_voc/VOCdevkit/VOC2007</span></span><br><span class="line">        self.cache_path = cfg.CACHE_PATH             <span class="comment">#data/pascal_voc/cache</span></span><br><span class="line">        self.batch_size = cfg.BATCH_SIZE             <span class="comment">#batch size 为 45</span></span><br><span class="line">        self.image_size = cfg.IMAGE_SIZE             <span class="comment"># image_size为 448*448</span></span><br><span class="line">        self.cell_size = cfg.CELL_SIZE              <span class="comment">#整张图片的cell_size*cell_size, 即7*7</span></span><br><span class="line">        self.classes = cfg.CLASSES                  <span class="comment">#pascal_voc的20个数据集</span></span><br><span class="line">        self.class_to_ind = dict(zip(self.classes, range(len(self.classes))))   <span class="comment">#将类转化为索引字典</span></span><br><span class="line">        self.flipped = cfg.FLIPPED      <span class="comment">#true</span></span><br><span class="line">        self.phase = phase             <span class="comment">#传过来的是字符串"train"</span></span><br><span class="line">        self.rebuild = rebuild         <span class="comment">#False</span></span><br><span class="line">        self.cursor = <span class="number">0</span></span><br><span class="line">        self.epoch = <span class="number">1</span></span><br><span class="line">        self.gt_labels = <span class="keyword">None</span></span><br><span class="line">        self.prepare()    <span class="comment">#call the function prepare, return gt_labels, 包含了经过水平翻转后的训练实例</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span>   <span class="comment">#获取到batch_size大小的图片和对应的label</span></span><br><span class="line">        images = np.zeros(</span><br><span class="line">            (self.batch_size, self.image_size, self.image_size, <span class="number">3</span>))</span><br><span class="line">        labels = np.zeros(</span><br><span class="line">            (self.batch_size, self.cell_size, self.cell_size, <span class="number">25</span>))</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> count &lt; self.batch_size:</span><br><span class="line">            imname = self.gt_labels[self.cursor][<span class="string">'imname'</span>]</span><br><span class="line">            flipped = self.gt_labels[self.cursor][<span class="string">'flipped'</span>]</span><br><span class="line">            images[count, :, :, :] = self.image_read(imname, flipped)  <span class="comment">#读取图片</span></span><br><span class="line">            labels[count, :, :, :] = self.gt_labels[self.cursor][<span class="string">'label'</span>]   <span class="comment">#图片的label</span></span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            self.cursor += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> self.cursor &gt;= len(self.gt_labels):</span><br><span class="line">                np.random.shuffle(self.gt_labels)  <span class="comment">#随机打乱gt_labels</span></span><br><span class="line">                self.cursor = <span class="number">0</span></span><br><span class="line">                self.epoch += <span class="number">1</span>     <span class="comment">#epoch加1</span></span><br><span class="line">        <span class="keyword">return</span> images, labels      <span class="comment">#返回batch_size大小的图片和对应的label，注意其shape</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">image_read</span><span class="params">(self, imname, flipped=False)</span>:</span>   <span class="comment">#读取图片</span></span><br><span class="line">        image = cv2.imread(imname)</span><br><span class="line">        image = cv2.resize(image, (self.image_size, self.image_size))  <span class="comment">#resize大小</span></span><br><span class="line">        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB).astype(np.float32)</span><br><span class="line">        image = (image / <span class="number">255.0</span>) * <span class="number">2.0</span> - <span class="number">1.0</span></span><br><span class="line">        <span class="keyword">if</span> flipped:</span><br><span class="line">            image = image[:, ::<span class="number">-1</span>, :]</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(self)</span>:</span></span><br><span class="line">        gt_labels = self.load_labels()  <span class="comment">#call the function load_labels, return gt_labels</span></span><br><span class="line">        <span class="keyword">if</span> self.flipped:</span><br><span class="line">            print(<span class="string">'Appending horizontally-flipped training examples ...'</span>)  <span class="comment">#附加水平翻转训练实例</span></span><br><span class="line">            gt_labels_cp = copy.deepcopy(gt_labels)  <span class="comment">#deep copy</span></span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(gt_labels_cp)):  <span class="comment">#循环一次处理一张图片</span></span><br><span class="line">                gt_labels_cp[idx][<span class="string">'flipped'</span>] = <span class="keyword">True</span> <span class="comment"># 原来的false变成true，即翻转</span></span><br><span class="line">                gt_labels_cp[idx][<span class="string">'label'</span>] =\</span><br><span class="line">                    gt_labels_cp[idx][<span class="string">'label'</span>][:, ::<span class="number">-1</span>, :]</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(self.cell_size):</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> range(self.cell_size):</span><br><span class="line">                        <span class="keyword">if</span> gt_labels_cp[idx][<span class="string">'label'</span>][i, j, <span class="number">0</span>] == <span class="number">1</span>:</span><br><span class="line">                            gt_labels_cp[idx][<span class="string">'label'</span>][i, j, <span class="number">1</span>] = \</span><br><span class="line">                                self.image_size - <span class="number">1</span> -\</span><br><span class="line">                                gt_labels_cp[idx][<span class="string">'label'</span>][i, j, <span class="number">1</span>]</span><br><span class="line">            gt_labels += gt_labels_cp</span><br><span class="line">        np.random.shuffle(gt_labels)</span><br><span class="line">        self.gt_labels = gt_labels</span><br><span class="line">        <span class="keyword">return</span> gt_labels   <span class="comment">#包含有经过水平翻转后的图片，包含经过水平翻转的训练实例</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_labels</span><span class="params">(self)</span>:</span>    <span class="comment">#加载标签文件，获取标签</span></span><br><span class="line">        cache_file = os.path.join(</span><br><span class="line">            self.cache_path, <span class="string">'pascal_'</span> + self.phase + <span class="string">'_gt_labels.pkl'</span>)    <span class="comment">##data/pascal_voc/cache/pascal_/train/_gt_labels.pkl</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(cache_file) <span class="keyword">and</span> <span class="keyword">not</span> self.rebuild:      <span class="comment">#从cache文件中读取labels</span></span><br><span class="line">            print(<span class="string">'Loading gt_labels from: '</span> + cache_file)</span><br><span class="line">            <span class="keyword">with</span> open(cache_file, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                gt_labels = pickle.load(f)</span><br><span class="line">            <span class="keyword">return</span> gt_labels</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Processing gt_labels from: '</span> + self.data_path)    <span class="comment">#data/pascal_voc/VOCdevkit/VOC2007</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.cache_path):    <span class="comment">#如果不存在这个文件则创建</span></span><br><span class="line">            os.makedirs(self.cache_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.phase == <span class="string">'train'</span>:       <span class="comment">#train</span></span><br><span class="line">            txtname = os.path.join(</span><br><span class="line">                self.data_path, <span class="string">'ImageSets'</span>, <span class="string">'Main'</span>, <span class="string">'trainval.txt'</span>)   <span class="comment">#加载trainval.txt文件</span></span><br><span class="line">        <span class="keyword">else</span>:                 <span class="comment">#test</span></span><br><span class="line">            txtname = os.path.join(</span><br><span class="line">                self.data_path, <span class="string">'ImageSets'</span>, <span class="string">'Main'</span>, <span class="string">'test.txt'</span>)</span><br><span class="line">        <span class="keyword">with</span> open(txtname, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.image_index = [x.strip() <span class="keyword">for</span> x <span class="keyword">in</span> f.readlines()]    <span class="comment">#加载得到图片的索引，以供train或者test</span></span><br><span class="line"></span><br><span class="line">        gt_labels = []   <span class="comment">#</span></span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> self.image_index: <span class="comment">#得到train或者test文件中所有指向图片的index,</span></span><br><span class="line">            label, num = self.load_pascal_annotation(index)   <span class="comment">#读取annotation文件, return label and len(objs)</span></span><br><span class="line">            <span class="keyword">if</span> num == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            imname = os.path.join(self.data_path, <span class="string">'JPEGImages'</span>, index + <span class="string">'.jpg'</span>)  <span class="comment">##data/pascal_voc/VOCdevkit/VOC2007/JPEGImages/index.jpg</span></span><br><span class="line">            gt_labels.append(&#123;<span class="string">'imname'</span>: imname,   <span class="comment">#图片的路径</span></span><br><span class="line">                              <span class="string">'label'</span>: label,</span><br><span class="line">                              <span class="string">'flipped'</span>: <span class="keyword">False</span>&#125;)</span><br><span class="line">        print(<span class="string">'Saving gt_labels to: '</span> + cache_file)</span><br><span class="line">        <span class="keyword">with</span> open(cache_file, <span class="string">'wb'</span>) <span class="keyword">as</span> f:   <span class="comment">#save the label to cache file</span></span><br><span class="line">            pickle.dump(gt_labels, f)</span><br><span class="line">        <span class="keyword">return</span> gt_labels</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_pascal_annotation</span><span class="params">(self, index)</span>:</span>    <span class="comment"># Load image and bounding boxes info from XML file in the PASCAL VOC format</span></span><br><span class="line"></span><br><span class="line">        imname = os.path.join(self.data_path, <span class="string">'JPEGImages'</span>, index + <span class="string">'.jpg'</span>)  <span class="comment">#data/pascal_voc/VOCdevkit/VOC2007/JPEGImages/index.jpg</span></span><br><span class="line">        im = cv2.imread(imname)</span><br><span class="line">        h_ratio = <span class="number">1.0</span> * self.image_size / im.shape[<span class="number">0</span>] <span class="comment"># 448所占图片高度的比例</span></span><br><span class="line">        w_ratio = <span class="number">1.0</span> * self.image_size / im.shape[<span class="number">1</span>] <span class="comment"># 448占图片宽度的比例</span></span><br><span class="line">        <span class="comment"># im = cv2.resize(im, [self.image_size, self.image_size])</span></span><br><span class="line"></span><br><span class="line">        label = np.zeros((self.cell_size, self.cell_size, <span class="number">25</span>))    <span class="comment">#label数组维度 7*7*25， 一个cell只负责预测一个类别</span></span><br><span class="line">        filename = os.path.join(self.data_path, <span class="string">'Annotations'</span>, index + <span class="string">'.xml'</span>) <span class="comment">#data/pascal_voc/VOCdevkit/VOC2007/Annotations/index.xml</span></span><br><span class="line">        tree = ET.parse(filename)   <span class="comment">#解析xml文件</span></span><br><span class="line">        objs = tree.findall(<span class="string">'object'</span>)   <span class="comment">#找到index指向的该xml文件中的所有object</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> objs:     <span class="comment">#记录出xml文件中object框的位置</span></span><br><span class="line">            bbox = obj.find(<span class="string">'bndbox'</span>)</span><br><span class="line">            <span class="comment"># Make pixel indexes 0-based</span></span><br><span class="line">            x1 = max(min((float(bbox.find(<span class="string">'xmin'</span>).text) - <span class="number">1</span>) * w_ratio, self.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            y1 = max(min((float(bbox.find(<span class="string">'ymin'</span>).text) - <span class="number">1</span>) * h_ratio, self.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            x2 = max(min((float(bbox.find(<span class="string">'xmax'</span>).text) - <span class="number">1</span>) * w_ratio, self.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            y2 = max(min((float(bbox.find(<span class="string">'ymax'</span>).text) - <span class="number">1</span>) * h_ratio, self.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            cls_ind = self.class_to_ind[obj.find(<span class="string">'name'</span>).text.lower().strip()]  <span class="comment"># class to index, matters</span></span><br><span class="line">            boxes = [(x2 + x1) / <span class="number">2.0</span>, (y2 + y1) / <span class="number">2.0</span>, x2 - x1, y2 - y1]  <span class="comment"># 将坐标(x1,y1,x2,y2)转变成(x_center,y_center,width,height)</span></span><br><span class="line">            x_ind = int(boxes[<span class="number">0</span>] * self.cell_size / self.image_size)   <span class="comment"># 查看object的x_center落在哪个cell, 整张图片cell的数量为7*7</span></span><br><span class="line">            y_ind = int(boxes[<span class="number">1</span>] * self.cell_size / self.image_size)   <span class="comment"># 查看object的y_center落在哪个cell， 整张图片cell的数量为7*7</span></span><br><span class="line">            <span class="keyword">if</span> label[y_ind, x_ind, <span class="number">0</span>] == <span class="number">1</span>:   <span class="comment">#设置一个标记，看其是否被访问过,同时也表明这是个object</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            label[y_ind, x_ind, <span class="number">0</span>] = <span class="number">1</span>   <span class="comment">#设置标记，1是已经被访问过了,同时也表明这是个object</span></span><br><span class="line">            label[y_ind, x_ind, <span class="number">1</span>:<span class="number">5</span>] = boxes  <span class="comment">#设置标记的框，框的形式为 ( x_center, y_center, width, height)</span></span><br><span class="line">            label[y_ind, x_ind, <span class="number">5</span> + cls_ind] = <span class="number">1</span>  <span class="comment">#标记类别，pascal_voc数据集一共有20个类，哪个类是哪个，则在响应的位置上的index是1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> label, len(objs)   <span class="comment">#返回label，以及该index文件中object的数量</span></span><br></pre></td></tr></table></figure>
<p>test.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> yolo.config <span class="keyword">as</span> cfg</span><br><span class="line"><span class="keyword">from</span> yolo.yolo_net <span class="keyword">import</span> YOLONet</span><br><span class="line"><span class="keyword">from</span> utils.timer <span class="keyword">import</span> Timer</span><br><span class="line"></span><br><span class="line"><span class="comment">#检测的类Detector</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Detector</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, net, weight_file)</span>:</span>   <span class="comment"># Yolo网络</span></span><br><span class="line">        self.net = net    <span class="comment">#网络</span></span><br><span class="line">        self.weights_file = weight_file  <span class="comment">#保留模型的文件</span></span><br><span class="line"></span><br><span class="line">        self.classes = cfg.CLASSES   <span class="comment"># PASCAL VOC数据集的20个类别</span></span><br><span class="line">        self.num_class = len(self.classes)  <span class="comment">#20</span></span><br><span class="line">        self.image_size = cfg.IMAGE_SIZE    <span class="comment">#image_size 448</span></span><br><span class="line">        self.cell_size = cfg.CELL_SIZE      <span class="comment">#cell_size 7</span></span><br><span class="line">        self.boxes_per_cell = cfg.BOXES_PER_CELL  <span class="comment">#每一个cell预测的框 2</span></span><br><span class="line">        self.threshold = cfg.THRESHOLD    <span class="comment">#0.2</span></span><br><span class="line">        self.iou_threshold = cfg.IOU_THRESHOLD  <span class="comment">#iou阈值 0.5</span></span><br><span class="line">        self.boundary1 = self.cell_size * self.cell_size * self.num_class  <span class="comment">#7*7*20</span></span><br><span class="line">        self.boundary2 = self.boundary1 +\</span><br><span class="line">            self.cell_size * self.cell_size * self.boxes_per_cell    <span class="comment">#7*7*20 + 7*7*2</span></span><br><span class="line"></span><br><span class="line">        self.sess = tf.Session()</span><br><span class="line">        self.sess.run(tf.global_variables_initializer())   <span class="comment">#tensorflow中初始化全局变量</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Restoring weights from: '</span> + self.weights_file)</span><br><span class="line">        self.saver = tf.train.Saver()</span><br><span class="line">        self.saver.restore(self.sess, self.weights_file)  <span class="comment">#从模型文件中恢复会话</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">draw_result</span><span class="params">(self, img, result)</span>:</span>   <span class="comment">#输出结果</span></span><br><span class="line">        print(<span class="string">"hell"</span>)</span><br><span class="line">        print(len(result))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(result)):</span><br><span class="line">            x = int(result[i][<span class="number">1</span>])</span><br><span class="line">            y = int(result[i][<span class="number">2</span>])</span><br><span class="line">            w = int(result[i][<span class="number">3</span>] / <span class="number">2</span>)</span><br><span class="line">            h = int(result[i][<span class="number">4</span>] / <span class="number">2</span>)</span><br><span class="line">            cv2.rectangle(img, (x - w, y - h), (x + w, y + h), (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            cv2.rectangle(img, (x - w, y - h - <span class="number">20</span>),</span><br><span class="line">                          (x + w, y - h), (<span class="number">125</span>, <span class="number">125</span>, <span class="number">125</span>), <span class="number">-1</span>)</span><br><span class="line">            lineType = cv2.LINE_AA <span class="keyword">if</span> cv2.__version__ &gt; <span class="string">'3'</span> <span class="keyword">else</span> cv2.CV_AA</span><br><span class="line">            cv2.putText(</span><br><span class="line">                img, result[i][<span class="number">0</span>] + <span class="string">' : %.2f'</span> % result[i][<span class="number">5</span>],</span><br><span class="line">                (x - w + <span class="number">5</span>, y - h - <span class="number">7</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.5</span>,</span><br><span class="line">                (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>, lineType)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detect</span><span class="params">(self, img)</span>:</span>  <span class="comment">#检测</span></span><br><span class="line">        img_h, img_w, _ = img.shape</span><br><span class="line">        inputs = cv2.resize(img, (self.image_size, self.image_size))   <span class="comment">#resize大小</span></span><br><span class="line">        inputs = cv2.cvtColor(inputs, cv2.COLOR_BGR2RGB).astype(np.float32)</span><br><span class="line">        inputs = (inputs / <span class="number">255.0</span>) * <span class="number">2.0</span> - <span class="number">1.0</span>        <span class="comment">#对图片处理一下</span></span><br><span class="line">        inputs = np.reshape(inputs, (<span class="number">1</span>, self.image_size, self.image_size, <span class="number">3</span>))  <span class="comment">#reshape一下， [batch_size, image_size, image_size, 3]</span></span><br><span class="line"></span><br><span class="line">        result = self.detect_from_cvmat(inputs)[<span class="number">0</span>]  <span class="comment">#返回已经是真实的坐标了</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">"输出result1:"</span>, result[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">        print(<span class="string">"输出result2:"</span>, result[<span class="number">0</span>][<span class="number">2</span>])</span><br><span class="line">        print(<span class="string">"输出result3:"</span>, result[<span class="number">0</span>][<span class="number">3</span>])</span><br><span class="line">        print(<span class="string">"输出result4:"</span>, result[<span class="number">0</span>][<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(result)):</span><br><span class="line">            result[i][<span class="number">1</span>] *= (<span class="number">1.0</span> * img_w / self.image_size)  <span class="comment">#x_center,是真实的坐标了</span></span><br><span class="line">            result[i][<span class="number">2</span>] *= (<span class="number">1.0</span> * img_h / self.image_size)  <span class="comment">#y_center</span></span><br><span class="line">            result[i][<span class="number">3</span>] *= (<span class="number">1.0</span> * img_w / self.image_size)  <span class="comment">#width</span></span><br><span class="line">            result[i][<span class="number">4</span>] *= (<span class="number">1.0</span> * img_h / self.image_size)  <span class="comment">#height</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detect_from_cvmat</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">        net_output = self.sess.run(self.net.logits,</span><br><span class="line">                                   feed_dict=&#123;self.net.images: inputs&#125;)  <span class="comment">#网络的输出</span></span><br><span class="line">        print(<span class="string">"net_output:"</span>,net_output.shape)  <span class="comment">#其维度为[batch_size, 7*7*30]</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(net_output.shape[<span class="number">0</span>]):  <span class="comment">#把每一张图片的预测放到一个list中</span></span><br><span class="line">            results.append(self.interpret_output(net_output[i]))   <span class="comment">#这一步是关键</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">interpret_output</span><span class="params">(self, output)</span>:</span>  <span class="comment">#进行阈值筛选（筛选的是类别置信度）和进行非极大值抑制</span></span><br><span class="line">        probs = np.zeros((self.cell_size, self.cell_size,</span><br><span class="line">                          self.boxes_per_cell, self.num_class))   <span class="comment">#维度为[7,7,2,20]</span></span><br><span class="line">        class_probs = np.reshape(   <span class="comment">#reshape之后，其维度为[7, 7, 20]</span></span><br><span class="line">            output[<span class="number">0</span>:self.boundary1],</span><br><span class="line">            (self.cell_size, self.cell_size, self.num_class))</span><br><span class="line">        scales = np.reshape(    <span class="comment">#reshape成[7, 7, 2]两个框的置信度</span></span><br><span class="line">            output[self.boundary1:self.boundary2],</span><br><span class="line">            (self.cell_size, self.cell_size, self.boxes_per_cell))</span><br><span class="line">        boxes = np.reshape(    <span class="comment">#reshape成[7, 7, 2, 4]的坐标框</span></span><br><span class="line">            output[self.boundary2:],</span><br><span class="line">            (self.cell_size, self.cell_size, self.boxes_per_cell, <span class="number">4</span>))</span><br><span class="line">        offset = np.array(   <span class="comment">#因为网络预测出来的是偏移量，因此要恢复</span></span><br><span class="line">            [np.arange(self.cell_size)] * self.cell_size * self.boxes_per_cell)</span><br><span class="line">        offset = np.transpose(</span><br><span class="line">            np.reshape(</span><br><span class="line">                offset,</span><br><span class="line">                [self.boxes_per_cell, self.cell_size, self.cell_size]),</span><br><span class="line">            (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        boxes[:, :, :, <span class="number">0</span>] += offset</span><br><span class="line">        boxes[:, :, :, <span class="number">1</span>] += np.transpose(offset, (<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">        boxes[:, :, :, :<span class="number">2</span>] = <span class="number">1.0</span> * boxes[:, :, :, <span class="number">0</span>:<span class="number">2</span>] / self.cell_size  <span class="comment">#得到(x_center, y_cwenter)相对于每一张图片的位置比例，self.cell_size=7</span></span><br><span class="line">        boxes[:, :, :, <span class="number">2</span>:] = np.square(boxes[:, :, :, <span class="number">2</span>:])     <span class="comment">#得到预测的宽度和高度乘以平方才能得到相对于整张图片的比例，于loss function中的定义一致</span></span><br><span class="line"></span><br><span class="line">        boxes *= self.image_size   <span class="comment">#得到相对于原图的坐标框</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.boxes_per_cell):   <span class="comment">#得到类别置信度， probs维度为[7, 7, 2, 20]</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(self.num_class):</span><br><span class="line">                probs[:, :, i, j] = np.multiply(</span><br><span class="line">                    class_probs[:, :, j], scales[:, :, i])</span><br><span class="line"></span><br><span class="line">        filter_mat_probs = np.array(probs &gt;= self.threshold, dtype=<span class="string">'bool'</span>)   <span class="comment">#如果大于self.threshold，那么其对应的位置为true,反正false</span></span><br><span class="line">        filter_mat_boxes = np.nonzero(filter_mat_probs)    <span class="comment">#找到为true的地方，用1来表示true, false是0</span></span><br><span class="line">        boxes_filtered = boxes[filter_mat_boxes[<span class="number">0</span>],</span><br><span class="line">                               filter_mat_boxes[<span class="number">1</span>], filter_mat_boxes[<span class="number">2</span>]] <span class="comment">#找到框的2位置，第三维度，不会用到第四位</span></span><br><span class="line">        probs_filtered = probs[filter_mat_probs]  <span class="comment">#找到符合的类别置信度</span></span><br><span class="line">        classes_num_filtered = np.argmax(  <span class="comment">#若该cell类别置信度大于阈值，则只取类别置信度最大的那个框，一个cell只负责预测一个类别</span></span><br><span class="line">            filter_mat_probs, axis=<span class="number">3</span>)[</span><br><span class="line">            filter_mat_boxes[<span class="number">0</span>], filter_mat_boxes[<span class="number">1</span>], filter_mat_boxes[<span class="number">2</span>]]</span><br><span class="line"></span><br><span class="line">        argsort = np.array(np.argsort(probs_filtered))[::<span class="number">-1</span>]  <span class="comment">#类别置信度排序</span></span><br><span class="line">        boxes_filtered = boxes_filtered[argsort]  <span class="comment">#找到符合条件的框，从大到小排序</span></span><br><span class="line">        probs_filtered = probs_filtered[argsort]  <span class="comment">#找到符合条件的类别置信度，从大到小排序</span></span><br><span class="line">        classes_num_filtered = classes_num_filtered[argsort]  <span class="comment">#类别数过滤</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(boxes_filtered)):  <span class="comment">#非极大值抑制算法， iou_threshold=0.5</span></span><br><span class="line">            <span class="keyword">if</span> probs_filtered[i] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i + <span class="number">1</span>, len(boxes_filtered)):</span><br><span class="line">                <span class="keyword">if</span> self.iou(boxes_filtered[i], boxes_filtered[j]) &gt; self.iou_threshold:</span><br><span class="line">                    probs_filtered[j] = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        filter_iou = np.array(probs_filtered &gt; <span class="number">0.0</span>, dtype=<span class="string">'bool'</span>)</span><br><span class="line">        boxes_filtered = boxes_filtered[filter_iou]  <span class="comment">#经过阈值和非极大值抑制之后得到的框</span></span><br><span class="line">        probs_filtered = probs_filtered[filter_iou]  <span class="comment">#经过阈值和非极大值抑制之后得到的类别置信度</span></span><br><span class="line">        classes_num_filtered = classes_num_filtered[filter_iou]  <span class="comment">#经过非极大值抑制之后得到的类别，一个cell只负责预测一个类别</span></span><br><span class="line"></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(boxes_filtered)):</span><br><span class="line">            result.append(</span><br><span class="line">                [self.classes[classes_num_filtered[i]],</span><br><span class="line">                 boxes_filtered[i][<span class="number">0</span>],</span><br><span class="line">                 boxes_filtered[i][<span class="number">1</span>],</span><br><span class="line">                 boxes_filtered[i][<span class="number">2</span>],</span><br><span class="line">                 boxes_filtered[i][<span class="number">3</span>],</span><br><span class="line">                 probs_filtered[i]])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iou</span><span class="params">(self, box1, box2)</span>:</span>  <span class="comment">#计算iou的</span></span><br><span class="line">        tb = min(box1[<span class="number">0</span>] + <span class="number">0.5</span> * box1[<span class="number">2</span>], box2[<span class="number">0</span>] + <span class="number">0.5</span> * box2[<span class="number">2</span>]) - \</span><br><span class="line">            max(box1[<span class="number">0</span>] - <span class="number">0.5</span> * box1[<span class="number">2</span>], box2[<span class="number">0</span>] - <span class="number">0.5</span> * box2[<span class="number">2</span>])</span><br><span class="line">        lr = min(box1[<span class="number">1</span>] + <span class="number">0.5</span> * box1[<span class="number">3</span>], box2[<span class="number">1</span>] + <span class="number">0.5</span> * box2[<span class="number">3</span>]) - \</span><br><span class="line">            max(box1[<span class="number">1</span>] - <span class="number">0.5</span> * box1[<span class="number">3</span>], box2[<span class="number">1</span>] - <span class="number">0.5</span> * box2[<span class="number">3</span>])</span><br><span class="line">        inter = <span class="number">0</span> <span class="keyword">if</span> tb &lt; <span class="number">0</span> <span class="keyword">or</span> lr &lt; <span class="number">0</span> <span class="keyword">else</span> tb * lr</span><br><span class="line">        <span class="keyword">return</span> inter / (box1[<span class="number">2</span>] * box1[<span class="number">3</span>] + box2[<span class="number">2</span>] * box2[<span class="number">3</span>] - inter)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">camera_detector</span><span class="params">(self, cap, wait=<span class="number">10</span>)</span>:</span>     <span class="comment">#相机检测</span></span><br><span class="line">        detect_timer = Timer()</span><br><span class="line">        ret, _ = cap.read()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ret:</span><br><span class="line">            ret, frame = cap.read()</span><br><span class="line">            detect_timer.tic()</span><br><span class="line">            result = self.detect(frame)</span><br><span class="line">            detect_timer.toc()</span><br><span class="line">            print(<span class="string">'Average detecting time: &#123;:.3f&#125;s'</span>.format(</span><br><span class="line">                detect_timer.average_time))</span><br><span class="line"></span><br><span class="line">            self.draw_result(frame, result)</span><br><span class="line">            cv2.imshow(<span class="string">'Camera'</span>, frame)</span><br><span class="line">            cv2.waitKey(wait)</span><br><span class="line"></span><br><span class="line">            ret, frame = cap.read()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">image_detector</span><span class="params">(self, imname, wait=<span class="number">0</span>)</span>:</span>   <span class="comment">#图片检测</span></span><br><span class="line">        detect_timer = Timer()</span><br><span class="line">        image = cv2.imread(imname)</span><br><span class="line"></span><br><span class="line">        detect_timer.tic()   <span class="comment">#记录检测开始的时间</span></span><br><span class="line">        result = self.detect(image)   <span class="comment">#检测</span></span><br><span class="line">        detect_timer.toc()   <span class="comment">#结束检测开始的时间</span></span><br><span class="line">        print(<span class="string">'Average detecting time: &#123;:.3f&#125;s'</span>.format(</span><br><span class="line">            detect_timer.average_time))</span><br><span class="line"></span><br><span class="line">        self.draw_result(image, result)</span><br><span class="line">        cv2.imshow(<span class="string">'Image'</span>, image)</span><br><span class="line">        cv2.waitKey(wait)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Detector的main函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    parser = argparse.ArgumentParser()   <span class="comment">#参数解析</span></span><br><span class="line">    parser.add_argument(<span class="string">'--weights'</span>, default=<span class="string">"YOLO_small.ckpt"</span>, type=str)</span><br><span class="line">    parser.add_argument(<span class="string">'--weight_dir'</span>, default=<span class="string">'weights'</span>, type=str)</span><br><span class="line">    parser.add_argument(<span class="string">'--data_dir'</span>, default=<span class="string">"data"</span>, type=str)</span><br><span class="line">    parser.add_argument(<span class="string">'--gpu'</span>, default=<span class="string">''</span>, type=str)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    os.environ[<span class="string">'CUDA_VISIBLE_DEVICES'</span>] = args.gpu</span><br><span class="line"></span><br><span class="line">    yolo = YOLONet(<span class="keyword">False</span>)   <span class="comment">#定义网络的框架</span></span><br><span class="line">    weight_file = os.path.join(args.data_dir, args.weight_dir, args.weights)  <span class="comment">#模型文件路径</span></span><br><span class="line">    detector = Detector(yolo, weight_file)   <span class="comment">#初始化Detector类</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># detect from camera</span></span><br><span class="line">    <span class="comment"># cap = cv2.VideoCapture(-1)</span></span><br><span class="line">    <span class="comment"># detector.camera_detector(cap)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># detect from image file</span></span><br><span class="line">    imname = <span class="string">'test/000021.jpg'</span>  <span class="comment">#测试文件</span></span><br><span class="line">    detector.image_detector(imname)</span><br><span class="line"></span><br><span class="line"><span class="comment">#main函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()  <span class="comment">#调用main函数</span></span><br></pre></td></tr></table></figure>
<p>train.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> yolo.config <span class="keyword">as</span> cfg</span><br><span class="line"><span class="keyword">from</span> yolo.yolo_net <span class="keyword">import</span> YOLONet</span><br><span class="line"><span class="keyword">from</span> utils.timer <span class="keyword">import</span> Timer</span><br><span class="line"><span class="keyword">from</span> utils.pascal_voc <span class="keyword">import</span> pascal_voc</span><br><span class="line"></span><br><span class="line">slim = tf.contrib.slim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solver</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, net, data)</span>:</span>   <span class="comment">#Yolon_net and pascal_voc_data</span></span><br><span class="line">        self.net = net   <span class="comment">#训练的网络</span></span><br><span class="line">        self.data = data  <span class="comment">#train或者test的数据</span></span><br><span class="line">        self.weights_file = cfg.WEIGHTS_FILE   <span class="comment">#权重文件</span></span><br><span class="line">        self.max_iter = cfg.MAX_ITER  <span class="comment">#迭代次数,迭代次数可自定义</span></span><br><span class="line">        self.initial_learning_rate = cfg.LEARNING_RATE  <span class="comment">#学习率，0.0001</span></span><br><span class="line">        self.decay_steps = cfg.DECAY_STEPS  <span class="comment">#衰变步数</span></span><br><span class="line">        self.decay_rate = cfg.DECAY_RATE   <span class="comment">#衰变率</span></span><br><span class="line">        self.staircase = cfg.STAIRCASE    <span class="comment">#true</span></span><br><span class="line">        self.summary_iter = cfg.SUMMARY_ITER <span class="comment"># SUMMARY_ITER, default 10</span></span><br><span class="line">        self.save_iter = cfg.SAVE_ITER   <span class="comment">#save itger, default 1000</span></span><br><span class="line">        self.output_dir = os.path.join(</span><br><span class="line">            cfg.OUTPUT_DIR, datetime.datetime.now().strftime(<span class="string">'%Y_%m_%d_%H_%M'</span>))  <span class="comment"># add time， data/pascal_voc/output/date_time</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.output_dir):  <span class="comment">#不存在则创建目录</span></span><br><span class="line">            os.makedirs(self.output_dir)</span><br><span class="line">        self.save_cfg()  <span class="comment">#保存配置</span></span><br><span class="line"></span><br><span class="line">        self.variable_to_restore = tf.global_variables()   <span class="comment">#初始化tensorflow的全局变量</span></span><br><span class="line">        self.saver = tf.train.Saver(self.variable_to_restore, max_to_keep=<span class="keyword">None</span>)  <span class="comment">#定义tf.saver</span></span><br><span class="line">        self.ckpt_file = os.path.join(self.output_dir, <span class="string">'yolo.ckpt'</span>)  <span class="comment">#定义保存模型输出的权重文件</span></span><br><span class="line">        self.summary_op = tf.summary.merge_all()   <span class="comment">#将tensorflow各个操作联合起来，省事</span></span><br><span class="line">        self.writer = tf.summary.FileWriter(self.output_dir, flush_secs=<span class="number">60</span>)   <span class="comment">#将内容写入到文件中，每60秒更新一次</span></span><br><span class="line"></span><br><span class="line">        self.global_step = tf.train.create_global_step()  <span class="comment">#创建全局的步骤</span></span><br><span class="line">        self.learning_rate = tf.train.exponential_decay(  <span class="comment">#设定变化的学习率，这个可以yolo论文中的相关指导来设定</span></span><br><span class="line">            self.initial_learning_rate, self.global_step, self.decay_steps,</span><br><span class="line">            self.decay_rate, self.staircase, name=<span class="string">'learning_rate'</span>)</span><br><span class="line">        self.optimizer = tf.train.GradientDescentOptimizer(   <span class="comment">#采用的优化方法是随机梯度下降</span></span><br><span class="line">            learning_rate=self.learning_rate)</span><br><span class="line">        self.train_op = slim.learning.create_train_op(   <span class="comment">#将tensorflow的operation联合起来</span></span><br><span class="line">            self.net.total_loss, self.optimizer, global_step=self.global_step)</span><br><span class="line"></span><br><span class="line">        gpu_options = tf.GPUOptions()</span><br><span class="line">        config = tf.ConfigProto(gpu_options=gpu_options)</span><br><span class="line">        self.sess = tf.Session(config=config)</span><br><span class="line">        self.sess.run(tf.global_variables_initializer())   <span class="comment">#初始化全局变量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.weights_file <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:  <span class="comment">#权重文件不等于None的时候</span></span><br><span class="line">            print(<span class="string">'Restoring weights from: '</span> + self.weights_file) <span class="comment">#加载预训练模型</span></span><br><span class="line">            self.saver.restore(self.sess, self.weights_file)    <span class="comment">#从预训练模型中restore</span></span><br><span class="line"></span><br><span class="line">        self.writer.add_graph(self.sess.graph)  <span class="comment">#加图</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(self)</span>:</span>  <span class="comment">#start training</span></span><br><span class="line"></span><br><span class="line">        train_timer = Timer()  <span class="comment">#train_timer</span></span><br><span class="line">        load_timer = Timer()   <span class="comment">#load_timer</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">1</span>, self.max_iter + <span class="number">1</span>):   <span class="comment">#开始训练</span></span><br><span class="line">            print(<span class="string">"step: "</span>,step)</span><br><span class="line">            load_timer.tic()</span><br><span class="line">            images, labels = self.data.get()    <span class="comment">#获取到batch_size大小的图片和对应的label</span></span><br><span class="line">            load_timer.toc()</span><br><span class="line">            feed_dict = &#123;self.net.images: images,</span><br><span class="line">                         self.net.labels: labels&#125;  <span class="comment">#喂数据</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> step % self.summary_iter == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> step % (self.summary_iter * <span class="number">10</span>) == <span class="number">0</span>:   <span class="comment">#将一些训练信息打印出来</span></span><br><span class="line"></span><br><span class="line">                    train_timer.tic()</span><br><span class="line">                    summary_str, loss, _ = self.sess.run(</span><br><span class="line">                        [self.summary_op, self.net.total_loss, self.train_op],</span><br><span class="line">                        feed_dict=feed_dict)</span><br><span class="line">                    train_timer.toc()</span><br><span class="line"></span><br><span class="line">                    log_str = <span class="string">'''&#123;&#125; Epoch: &#123;&#125;, Step: &#123;&#125;, Learning rate: &#123;&#125;,'''</span></span><br><span class="line">                    <span class="string">''' Loss: &#123;:5.3f&#125;\nSpeed: &#123;:.3f&#125;s/iter,'''</span></span><br><span class="line">                    <span class="string">'''' Load: &#123;:.3f&#125;s/iter, Remain: &#123;&#125;'''</span>.format(</span><br><span class="line">                        datetime.datetime.now().strftime(<span class="string">'%m-%d %H:%M:%S'</span>),</span><br><span class="line">                        self.data.epoch,</span><br><span class="line">                        int(step),</span><br><span class="line">                        round(self.learning_rate.eval(session=self.sess), <span class="number">6</span>),</span><br><span class="line">                        loss,</span><br><span class="line">                        train_timer.average_time,</span><br><span class="line">                        load_timer.average_time,</span><br><span class="line">                        train_timer.remain(step, self.max_iter))</span><br><span class="line">                    print(log_str)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    train_timer.tic()</span><br><span class="line">                    summary_str, _ = self.sess.run(</span><br><span class="line">                        [self.summary_op, self.train_op],</span><br><span class="line">                        feed_dict=feed_dict)</span><br><span class="line">                    train_timer.toc()</span><br><span class="line"></span><br><span class="line">                self.writer.add_summary(summary_str, step)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:    <span class="comment">#只是训练，不打印出信息</span></span><br><span class="line">                train_timer.tic()</span><br><span class="line">                self.sess.run(self.train_op, feed_dict=feed_dict)</span><br><span class="line">                train_timer.toc()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> step % self.save_iter == <span class="number">0</span>:   <span class="comment">#保留检查点，以供测试时用</span></span><br><span class="line">                print(<span class="string">'&#123;&#125; Saving checkpoint file to: &#123;&#125;'</span>.format(</span><br><span class="line">                    datetime.datetime.now().strftime(<span class="string">'%m-%d %H:%M:%S'</span>),</span><br><span class="line">                    self.output_dir))</span><br><span class="line">                self.saver.save(    <span class="comment">#保存会话，将模型文件保存</span></span><br><span class="line">                    self.sess, self.ckpt_file, global_step=self.global_step)</span><br><span class="line">                print(<span class="string">"save done!!!"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_cfg</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(os.path.join(self.output_dir, <span class="string">'config.txt'</span>), <span class="string">'w'</span>) <span class="keyword">as</span> f:   <span class="comment">#把配置信息写入到文件中</span></span><br><span class="line">            cfg_dict = cfg.__dict__</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> sorted(cfg_dict.keys()):</span><br><span class="line">                <span class="keyword">if</span> key[<span class="number">0</span>].isupper():</span><br><span class="line">                    cfg_str = <span class="string">'&#123;&#125;: &#123;&#125;\n'</span>.format(key, cfg_dict[key])</span><br><span class="line">                    f.write(cfg_str)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_config_paths</span><span class="params">(data_dir, weights_file)</span>:</span>    <span class="comment">#更新配置文件路径</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"应该是加载了YOLO_small.ckpt"</span>)</span><br><span class="line">    cfg.DATA_PATH = data_dir</span><br><span class="line">    cfg.PASCAL_PATH = os.path.join(data_dir, <span class="string">'pascal_voc'</span>)</span><br><span class="line">    cfg.CACHE_PATH = os.path.join(cfg.PASCAL_PATH, <span class="string">'cache'</span>)</span><br><span class="line">    cfg.OUTPUT_DIR = os.path.join(cfg.PASCAL_PATH, <span class="string">'output'</span>)</span><br><span class="line">    cfg.WEIGHTS_DIR = os.path.join(cfg.PASCAL_PATH, <span class="string">'weights'</span>)</span><br><span class="line"></span><br><span class="line">    cfg.WEIGHTS_FILE = os.path.join(cfg.WEIGHTS_DIR, weights_file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>    <span class="comment">#自定义参数</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">'--weights'</span>, default=<span class="string">"YOLO_small.ckpt"</span>, type=str)  <span class="comment">#定义权重文件</span></span><br><span class="line">    parser.add_argument(<span class="string">'--data_dir'</span>, default=<span class="string">"data"</span>, type=str)  <span class="comment">#定义数据文件夹</span></span><br><span class="line">    parser.add_argument(<span class="string">'--threshold'</span>, default=<span class="number">0.2</span>, type=float)  <span class="comment">#阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">'--iou_threshold'</span>, default=<span class="number">0.5</span>, type=float)  <span class="comment">#IOU阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">'--gpu'</span>, default=<span class="string">''</span>, type=str)   <span class="comment">#是否用gpu训练</span></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.gpu <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:   <span class="comment">#是否用gpu训练</span></span><br><span class="line">        cfg.GPU = args.gpu</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.data_dir != cfg.DATA_PATH:</span><br><span class="line">        update_config_paths(args.data_dir, args.weights)</span><br><span class="line"></span><br><span class="line">    os.environ[<span class="string">'CUDA_VISIBLE_DEVICES'</span>] = cfg.GPU</span><br><span class="line"></span><br><span class="line">    yolo = YOLONet()   <span class="comment">#Yolo网络</span></span><br><span class="line">    pascal = pascal_voc(<span class="string">'train'</span>)     <span class="comment">#获得训练的数据， 包含了经过水平翻转后的训练实例</span></span><br><span class="line"></span><br><span class="line">    solver = Solver(yolo, pascal)  <span class="comment">#准备训练的环境，包括设置优化器，学习率等内容</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">'Start training ...'</span>)</span><br><span class="line">    solver.train()  <span class="comment">#start training</span></span><br><span class="line">    print(<span class="string">'done!!!'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># f = open('result.txt', 'w')</span></span><br><span class="line">    <span class="comment"># f.write('train finished!!!!')</span></span><br><span class="line">    <span class="comment"># f.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># python train.py --weights YOLO_small.ckpt --gpu 0</span></span><br><span class="line">    main()  <span class="comment"># main 函数</span></span><br></pre></td></tr></table></figure>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="http://music.163.com/song/media/outer/url?id=456185577">
            </audio>
            
        </div>
        
    <div id="gitalk-container" class="comment link" data-ae="false" data-ci="389843d8e8f4a64fb373" data-cs="4aa2f626551b60a563b935cf7f7c5273b68b28aa" data-r="blogissue" data-o="eggtargaryen" data-a="eggtargaryen" data-d="false">查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>